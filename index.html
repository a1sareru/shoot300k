<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="あなたと友人になれたら🎶" />
  <meta name="author" content="とある名無し賢者" />
  <title>shoot300k</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- 固定顶部的导航栏 -->
  <nav class="navbar">
    <a class="nav-item active" data-target="main">✨ Top</a>
    <a class="nav-item" data-target="selectCards">🎴 持有卡牌</a>
    <a class="nav-item" data-target="calc">🧮 卡组计算</a>
    <a class="nav-item" data-target="about">🤫 关于</a>
  </nav>

  <!-- 各个页面 -->
  <div class="container">
    <!-- Top -->
    <div id="main" class="tab-content">
      <p>这是某位懒惰贤者为自己开发的双色银卡组配卡助手。（<span id="last-updated">加载中...</span>）</p>
      <p><strong>请尽可能在电脑浏览器使用！</strong>只做了最低程度的适配，所以不推荐移动端使用……！</p>
      <p>站点完全基于前端运行，不会存储您的任何数据，请放心使用。</p>
      <h3>🍎 使用方法</h3>
      <ul>
        <li>首先，在「持有卡牌」页面，通过选中卡牌，生成您的「卡牌库存」字符串。</li>
        <li>然后，前往「卡组计算」页面，输入导出的「卡牌库存」字符串，进行计算。</li>
      </ul>

      <h3>⚠️ 注意事项</h3>
      <ul>
        <li>站点内的所有操作均只考虑 SSR 和 SR 类型的卡牌；</li>
        <li>数据大部分来源于<span class="spoiler">游戏文件解包</span>，其余由人工自行补充；</li>
        </li>
        <li>【卡牌序号问题·其一】由于 coly <del style="color: gray;">不知出于何种考虑</del>
          将<u><strong>【賢者様の世界の味】アーサー</strong></u> 的 ID 设为 356（原本应为 337），
          因此，本站点对所有 ID 大于 336 的卡片进行了 +19 的调整。请确保使用正确的数据进行计算。
          （若使用「持有卡牌」页面导出数据，且未做额外修改，则可忽略此提示）；</li>
        <li>【卡牌序号问题·其二】此外，本站点假设 <strong>【ぴかぴか見ーつけた！】ムル</strong> 及其后的所有卡片 ID
          均未受上述调整影响（即：【ぴかぴか見ーつけた！】ムル = 1106）。
          未来若游戏数据更新，相关卡片 ID 可能会有所变动，届时相关调整将在本页面注明，敬请留意；</li>
        <li>如有错漏报告或其他建议，欢迎联系开发者🙌；</li>
        <li>开发者的联系方式，以及有关该项目的更多信息，请参阅「关于」页面。</li>
      </ul>

      <h3>📣 公告板</h3>
      <p style="font-size: smaller;">（※本版块最后更新时间：2025-02-02 14:45:19 UTC）</p>
      <p>🚧 工事中……</p>
    </div>
    <!-- 持有卡牌 -->
    <div id="selectCards" class="tab-content" style="margin: 10px;">
      <div class="selectCards-header">
        <div class="submit-result-container">
          <button id="submit-cards" class="submit-btn">提交选卡</button>
          <button id="copy-result" class="copy-btn" style="display: none;">复制结果</button>
          <div id="selected-ids" class="result-text"></div>
        </div>
      </div>
      <!-- 滚动区域：卡牌列表 -->
      <div class="selectCards-scrollable">
        <div id="card-list">加载中...</div>
      </div>
    </div>
    <!-- 卡组计算 -->
    <div id="calc" class="tab-content">
      <h2>卡组计算</h2>
      <p>TODO：根据特定的输入进行计算。</p>
    </div>
    <!-- 关于 -->
    <div id="about" class="tab-content">
      <h3>⚖️ Disclaimer</h3>
      <p>本工具仅供个人研究与学习使用，任何使用本工具的行为均应符合适用法律法规。开发者不对任何用户的使用方式负责，亦不承担任何由此引发的法律责任。</p>
      <p>本工具不存储、不传播任何受版权保护的内容。如果本工具被认为侵犯了您的合法权益，请通过电子邮件联系我们，我们将立即停止相关内容的提供并进行删除。</p>
      <p>开发者放弃对此工具的所有权利，包括但不限于知识产权、商业利益和后续维护责任。本工具以“原样”提供，不保证其准确性、完整性或适用性，使用者需自行承担所有风险。</p>
      <p>联系方式：<a href="mailto:kmbk.kr.dev@outlook.jp">kmbk.kr.dev[AT]outlook.jp</a></p>
    </div>
  </div>

  <!-- 底栏 -->
  <footer class="bottom-bar text-center">
    <p>© 2025 とある名無し賢者. All rights waived.</p>
  </footer>

  <!-- 动作脚本 -->
  <script>
    // 获取所有导航项和内容区域
    const tabs = document.querySelectorAll(".nav-item");
    const sections = document.querySelectorAll(".section");

    // 监听点击事件
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        // 移除所有的 active 类
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(section => section.classList.remove("active"));

        // 添加 active 类到被点击的选项和相应内容
        tab.classList.add("active");
        document.getElementById(tab.getAttribute("data-target")).classList.add("active");
      });
    });

    async function fetchLastUpdated(owner, repo) {
      const url = `https://api.github.com/repos/${owner}/${repo}`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`GitHub API 请求失败: ${response.status}`);

        const data = await response.json();
        const lastUpdated = new Date(data.pushed_at).toLocaleString("zh-CN", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false // 24小时制
        });

        document.getElementById("last-updated").textContent = `最后更新: ${lastUpdated}`;
      } catch (error) {
        document.getElementById("last-updated").textContent = "获取失败";
        console.error("获取 GitHub 仓库信息失败:", error);
      }
    }

    fetchLastUpdated("a1sareru", "shoot300k");

    // 加载 CSV 数据并显示持有卡牌
    function loadCards() {
      fetch('https://raw.githubusercontent.com/a1sareru/shoot300k/refs/heads/main/public/data/character_card.csv')
        .then(response => {
          if (!response.ok) {
            throw new Error('无法加载CSV文件');
          }
          return response.text();
        })
        .then(csvText => {
          const cards = parseCSV(csvText);
          // 过滤只显示 SSR 和 SR（rarity 为 4 或 3）
          const filteredCards = cards.filter(card => {
            const rarity = card.rarity.trim();
            return rarity === "4" || rarity === "3";
          });
          renderCards(filteredCards);
        })
        .catch(error => {
          document.getElementById('card-list').innerText = '加载卡牌数据出错: ' + error;
          console.error(error);
        });
    }

    // 简单 CSV 解析器（假设 CSV 没有字段内嵌逗号，且以换行分隔）
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      const data = lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((header, index) => {
          obj[header.trim()] = values[index] ? values[index].trim() : "";
        });
        return obj;
      });
      return data;
    }

    // 渲染卡牌列表到页面
    function renderCards(cards) {
      const cardListEl = document.getElementById('card-list');
      if (cards.length === 0) {
        cardListEl.innerText = '没有找到符合条件的卡牌。';
        return;
      }
      cardListEl.innerHTML = '';
      cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card';
        cardEl.dataset.id = card.id;
        if (card.rarity.trim() === "4") {
          cardEl.classList.add('gold-border');
        } else if (card.rarity.trim() === "3") {
          cardEl.classList.add('silver-border');
        }
        // 设置卡牌内容（图片和标题）
        cardEl.innerHTML = `
          <figure style="display: flex; flex-direction: column; align-items: center; margin: 0;">
            <img src="https://raw.githubusercontent.com/a1sareru/shoot300k/refs/heads/main/public/images/cards/${card.id}.jpg" 
                alt="${card.title}" 
                style="width: 34px; height: 60px;" 
                onerror="this.src='';" />
            <figcaption style="font-size: 9px; text-align: center; white-space: normal; word-break: break-word; line-height: 1.7; margin: 2px 0; padding: 2px;">
              ${(() => {
            const modified = card.title.replace(/【/g, '').replace(/】/g, '<br>') + " | " + card.id;
            const lines = modified.split('<br>');
            if (lines.length > 0) {
              lines[0] = `<strong style="font-size: 10.5px; font-weight: 900; color: #000; -webkit-text-stroke: 0.3px #a7d8e8;">${lines[0]}</strong>`;
            }
            return lines.join('<br>');
          })()}
            </figcaption>
          </figure>
        `;
        cardEl.addEventListener('click', () => {
          cardEl.classList.toggle('selected');
        });
        cardListEl.appendChild(cardEl);
      });
    }

    // 提交选卡，显示结果
    document.getElementById('submit-cards').addEventListener('click', () => {
      const selectedCards = document.querySelectorAll('.card.selected');
      const selectedIds = Array.from(selectedCards).map(card => card.dataset.id);
      const idString = selectedIds.join(',');
      document.getElementById('selected-ids').innerText = idString;
      const copyButton = document.getElementById('copy-result');
      copyButton.style.display = idString.trim().length > 0 ? 'inline-block' : 'none';
    });

    // 复制功能
    document.getElementById('copy-result').addEventListener('click', () => {
      const resultText = document.getElementById('selected-ids').innerText;
      navigator.clipboard.writeText(resultText)
        .then(() => { alert('结果已复制到剪贴板'); })
        .catch(err => { alert('复制失败，请手动复制'); console.error(err); });
    });

    document.addEventListener("DOMContentLoaded", function() {
      document.querySelector(".nav-item[data-target='main']").classList.add("active");
      document.querySelector("#main").classList.add("active");
      // 1. 获取所有的导航项
      const navItems = document.querySelectorAll(".nav-item");

      // 2. 监听点击事件
      navItems.forEach(item => {
        item.addEventListener("click", function() {
          // 2.1 移除所有导航项的 active 类
          navItems.forEach(nav => nav.classList.remove("active"));

          // 2.2 给当前点击的导航项添加 active 类
          this.classList.add("active");

          // 2.3 获取对应的 tab-content ID
          const targetId = this.getAttribute("data-target");

          // 2.4 隐藏所有 tab-content
          document.querySelectorAll(".tab-content").forEach(tab => {
            tab.classList.remove("active");
          });

          // 2.5 显示对应的 tab-content
          document.getElementById(targetId).classList.add("active");

          // 🚀 只有 "持有卡牌" 界面时，禁止 body 滚动
          if (targetId === "selectCards") {
            document.body.style.overflow = "hidden";
            loadCards();
          } else {
            document.body.style.overflow = "auto";
          }
        });
      });
    });
  </script>
</body>

</html>